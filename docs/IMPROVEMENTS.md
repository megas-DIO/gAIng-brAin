# gAIng Brain Improvements

Generated by Claude on 2026-01-03. Apply these changes to harden the codebase.

## Installed Dependencies

```bash
npm install cors express-rate-limit --save
```

## 1. Add CORS & Rate Limiting to `src/app.js`

Add at the top (after `const express = require('express');`):

```javascript
const cors = require('cors');
const rateLimit = require('express-rate-limit');

// CORS - allow configured origins or all in dev
const corsOptions = {
    origin: process.env.CORS_ORIGINS ? process.env.CORS_ORIGINS.split(',') : '*',
    methods: ['GET', 'POST', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
};
app.use(cors(corsOptions));

// Rate limiting - 100 requests per minute per IP
const limiter = rateLimit({
    windowMs: 60 * 1000,
    max: process.env.RATE_LIMIT || 100,
    message: { ok: false, error: 'Too many requests, please try again later' },
    standardHeaders: true,
    legacyHeaders: false
});
app.use(limiter);
```

## 2. Add Graceful Shutdown to `index.js`

Add at the end (before the final `});`):

```javascript
// Graceful shutdown
function gracefulShutdown(signal) {
    console.log(`\n${signal} received. Shutting down gracefully...`);

    // Close WebSocket connections
    wss.clients.forEach(client => {
        client.close(1001, 'Server shutting down');
    });

    // Close HTTP server
    server.close(() => {
        console.log('HTTP server closed.');
        process.exit(0);
    });

    // Force exit after 10 seconds
    setTimeout(() => {
        console.error('Could not close connections in time, forcing exit');
        process.exit(1);
    }, 10000);
}

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
```

## 3. Fix Supabase Client in `src/agent-worker.js`

Change line 16:
```javascript
// FROM:
process.env.SUPABASE_KEY

// TO:
process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY
```

## 4. Fix Blocking File Operations in `src/agent-worker.js`

Change `logToBlock` function:
```javascript
// Add at top:
const fsPromises = require('fs').promises;

// Replace logToBlock:
async function logToBlock(message) {
    const timestamp = new Date().toISOString().replace('T', ' ').slice(0, 19);
    const entry = `- ${timestamp} [${AGENT_ID.toUpperCase()}] ${message}\n`;
    await fsPromises.appendFile(LOG_FILE, entry).catch(err => console.error('Log write failed:', err));
    console.log(entry.trim());
}
```

Note: All callers of `logToBlock()` must use `await`.

## 5. Add Input Validation to `src/routes/tasks.js`

Add priority validation:
```javascript
// Before using priority:
const priority = Math.min(10, Math.max(1, Number(req.body.priority) || 5));
if (!Number.isInteger(priority)) {
    return res.status(400).json({ ok: false, error: 'Invalid priority' });
}
```

## 6. Add Message Length Validation to `src/routes/safa.js`

```javascript
const MAX_MESSAGE_LENGTH = 10000;
if (!message || message.length > MAX_MESSAGE_LENGTH) {
    return res.status(400).json({ ok: false, error: 'Message required (max 10000 chars)' });
}
```

## 7. Log Rotation

Created `scripts/rotate-logs.js`. Add to package.json:
```json
"scripts": {
    "rotate-logs": "node scripts/rotate-logs.js"
}
```

Schedule with cron (Linux) or Task Scheduler (Windows):
```
0 0 * * * node /path/to/gAIng-Brain/scripts/rotate-logs.js
```

## 8. Environment Variables to Add

Add to `.env`:
```
CORS_ORIGINS=http://localhost:3000,https://yourdomain.com
RATE_LIMIT=100
```

## Priority Order

1. **Immediate**: CORS + Rate Limiting (security)
2. **High**: Graceful shutdown (stability)
3. **Medium**: Input validation (security)
4. **Low**: Async file operations (performance)

## Verification

After applying changes:
```bash
npm test
npm run health:db
curl -I http://localhost:8080/health  # Check CORS headers
```
